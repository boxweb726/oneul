<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>오늘뭐볼까? - 커뮤니티 글쓰기</title>
  <link href="css/style.css" rel="stylesheet">
  <link href="css/common.css" rel="stylesheet">
  <link rel="icon" href="./images/logo_favicon.png" type="image/x-icon">
</head>
<body>

<!-- 필수 호출 script -->
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const firebaseConfig = {
  apiKey: "AIzaSyBPwBvkUab2QHIgqTPODBIC8gWWowDohjM",
  authDomain: "oneul-9b3e4.firebaseapp.com",
  databaseURL: "https://oneul-9b3e4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "oneul-9b3e4",
  storageBucket: "oneul-9b3e4.appspot.com",
  messagingSenderId: "993417131341",
  appId: "1:993417131341:web:ce271d5bffa75a7d42f304"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
</script>
<!-- 필수 호출 script -->

<main id="contents">
  <header class="header-wrap">
    <a href="/"><img src="/images/logo.svg"></a>
  </header>
  <section class="content h-100">
    <div class="post-write h-100">
      <form id="form" class="h-100 d-flex flex-column">
        <input type="text" placeholder="제목" id="title" class="oneul-form" required>
        <textarea id="content" class="oneul-form flex-1" placeholder="내용을 입력하세요" required style="resize:none"></textarea>
        <input type="file" id="image" class="oneul-form">
        <button type="submit" id="send" class="oneul-btn">글등록</button>
      </form>
    </div>
  </section>
  <footer class="footer-wrap">
    <div class="navigator">
      <a href="/index.html" class="nav-item home"><span class="nav-txt">홈</span></a>
      <a href="/search.html" class="nav-item search"><span class="nav-txt">검색</span></a>
      <a href="/list.html" class="nav-item community active"><span class="nav-txt">커뮤니티</span></a>
      <a href="/mypage.html" class="nav-item my-page"><span class="nav-txt">MY</span></a>
    </div>
  </footer>
</main>

  <script>
    const db = firebase.firestore();
    const storage = firebase.storage();

    $('#send').click(function(e){
      const form = document.querySelector("#form");
      let state = form.checkValidity();
      if(!!state) {
        e.preventDefault();

        // 이미지 파일 관련 변수 설정
        var file = document.querySelector('#image').files[0]; 
        var storageRef = storage.ref();
        var savePath = storageRef.child('image/' + file?.name);
        var upload = savePath.put(file);

        upload.on( 'state_changed', 
            // 변화시 동작하는 함수 
            null, 
            //에러시 동작하는 함수
            (error) => {
              console.error('실패사유는', error);
            }, 
            // 성공시 동작하는 함수
            () => {
              upload.snapshot.ref.getDownloadURL().then((url) => {
                console.log('업로드된 경로는', url);

                // 글 작성 시 저장할 데이터의 값
                var postData = {
                  제목 : $('#title').val(),
                  내용 : $('#content').val(),
                  날짜 : new Date(),
                  uid : JSON.parse(localStorage.getItem('user')).uid,
                  이름 : JSON.parse(localStorage.getItem('user')).displayName,
                  이미지 : url,
                }
                // firebase 문법 이용하여 post collection 에 등록 후 리스트 페이지 이동
                db.collection('post').add(postData).then((result)=>{
                  console.log(result);
                  window.location.href = "/list.html"
                }).catch((err)=>{
                  console.log(err)
                })
              });
            }
        );     
      }
    })
  </script>
  
</body>
</html>